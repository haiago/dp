<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Màn Hình Hiển Thị</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        overflow: hidden;
      }

      #display-page {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        position: relative;
        background-size: cover;
        background-position: center;
      }

      #scrolling-text {
        position: absolute;
        left: 100%;
        white-space: nowrap;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      }

      #new-item-text {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        display: none;
      }

      #total-text {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        display: none;
      }

      #thank-you-text {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        display: none;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }

      .blinking {
        animation: blink 1s ease-in-out infinite;
      }

      .settings-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .settings-btn:hover {
        background: #545b62;
      }
    </style>
  </head>
  <body>
    <!-- <button class="settings-btn" onclick="openSettings()">⚙️ Cấu hình</button>-->

    <div id="display-page">
      <div id="scrolling-text"></div>
      <div id="new-item-text"></div>
      <div id="total-text"></div>
      <div id="thank-you-text"></div>
    </div>

    <script>
      let config = {
        donations: [],
        backgroundUrl: "",
        fontSize: 60,
        textPosition: 500,
        scrollSpeed: 100,
        loopTime: 10,
        textColor: "#FF0000",
        showScrolling: false,
        showScrollingShadow: true,
        scrollingItemLimit: 50,
        showNewItem: true,
        newItemFontSize: 60,
        newItemColor: "#FF0000",
        newItemPosition: 500,
        newItemBlinkInterval: 3,
        newItemDisplayTime: 10,
        showNewItemShadow: true,
        showTotal: true,
        totalFontSize: 40,
        totalColor: "#528515",
        totalPosition: 600,
        showTotalShadow: true,
        showThankYou: true,
        thankYouText: "TRÂN TRỌNG CẢM ƠN QUÝ ÂN NHÂN",
        thankYouFontSize: 40,
        thankYouColor: "#f56666",
        thankYouPosition: 700,
        showThankYouShadow: true,
        autoLoopTime: 30,
        autoLoopItemLimit: 50,
      };

      let scrollAnimation;
      let newItemTimeout;
      let newItemBlinkInterval;
      let newItemHideTimeout;
      let lastDonationCount = 0;
      let autoLoopTimeout;
      let autoLoopInterval;
      let currentAutoLoopIndex = 0;
      let lastNewItemTime = Date.now();

      // Load dữ liệu
      function loadData() {
        const saved = localStorage.getItem("scrollingTextConfig");
        if (saved) {
          config = JSON.parse(saved);
          lastDonationCount = config.donations.length;
          applyConfig();
        }
      }

      // Áp dụng cấu hình
      function applyConfig() {
        const displayPage = document.getElementById("display-page");
        const scrollingText = document.getElementById("scrolling-text");
        const newItemText = document.getElementById("new-item-text");
        const totalText = document.getElementById("total-text");
        const thankYouText = document.getElementById("thank-you-text");

        // Áp dụng background
        if (config.backgroundUrl) {
          displayPage.style.backgroundImage = `url(${config.backgroundUrl})`;
        }

        // Áp dụng style chữ chạy
        scrollingText.style.fontSize = config.fontSize + "px";
        scrollingText.style.top = config.textPosition + "px";
        scrollingText.style.color = config.textColor || "#FFD700";
        scrollingText.style.display =
          config.showScrolling !== false ? "block" : "none";
        scrollingText.style.textShadow =
          config.showScrollingShadow !== false
            ? "2px 2px 4px rgba(0, 0, 0, 0.8)"
            : "none";

        // Áp dụng style item mới
        newItemText.style.fontSize = (config.newItemFontSize || 60) + "px";
        newItemText.style.top = (config.newItemPosition || 500) + "px";
        newItemText.style.color = config.newItemColor || "#FF0000";
        newItemText.style.textShadow =
          config.showNewItemShadow !== false
            ? "2px 2px 4px rgba(0, 0, 0, 0.8)"
            : "none";

        // Áp dụng style tổng cộng
        totalText.style.fontSize = (config.totalFontSize || 40) + "px";
        totalText.style.top = (config.totalPosition || 600) + "px";
        totalText.style.color = config.totalColor || "#528515";
        totalText.style.textShadow =
          config.showTotalShadow !== false
            ? "2px 2px 4px rgba(0, 0, 0, 0.8)"
            : "none";

        // Hiển thị tổng cộng
        if (config.showTotal !== false) {
          const total = config.donations.reduce((sum, d) => sum + d.amount, 0);
          totalText.textContent = `Tổng cộng: ${total.toLocaleString(
            "vi-VN"
          )} VNĐ`;
          totalText.style.display = "block";
        } else {
          totalText.style.display = "none";
        }

        // Áp dụng style cảm ơn
        thankYouText.style.fontSize = (config.thankYouFontSize || 40) + "px";
        thankYouText.style.top = (config.thankYouPosition || 700) + "px";
        thankYouText.style.color = config.thankYouColor || "#f56666";
        thankYouText.style.textShadow =
          config.showThankYouShadow !== false
            ? "2px 2px 4px rgba(0, 0, 0, 0.8)"
            : "none";

        if (config.showThankYou !== false) {
          thankYouText.textContent =
            config.thankYouText || "TRÂN TRỌNG CẢM ƠN QUÝ ÂN NHÂN";
          thankYouText.style.display = "block";
        } else {
          thankYouText.style.display = "none";
        }
      }

      // Tạo chuỗi chữ chạy (giới hạn số lượng items)
      function generateScrollText() {
        if (config.donations.length === 0) {
          return "Chưa có thông tin nào được thêm...";
        }

        // Lấy X items gần nhất
        const limit = config.scrollingItemLimit || 50;
        const itemsToShow = config.donations.slice(-limit);

        return (
          itemsToShow
            .map((d) => `${d.name}: ${d.amount.toLocaleString("vi-VN")} VNĐ`)
            .join(" ★ ") + " ★ "
        );
      }

      // Bắt đầu chữ chạy
      function startScrolling() {
        const scrollingText = document.getElementById("scrolling-text");

        if (config.showScrolling === false) {
          scrollingText.style.display = "none";
          return;
        }

        scrollingText.style.display = "block";
        const text = generateScrollText();
        scrollingText.textContent = text;

        if (scrollAnimation) {
          cancelAnimationFrame(scrollAnimation);
        }

        let position = window.innerWidth;
        const textWidth = scrollingText.offsetWidth;
        let hasFinishedOnce = false;
        let finishTime = null;

        function animate() {
          position -= config.scrollSpeed / 60;

          if (position < -textWidth) {
            if (!hasFinishedOnce) {
              hasFinishedOnce = true;
              finishTime = Date.now();
            }

            const timeSinceFinish = (Date.now() - finishTime) / 1000;

            if (timeSinceFinish >= config.loopTime) {
              position = window.innerWidth;
              hasFinishedOnce = false;
              finishTime = null;

              const newText = generateScrollText();
              scrollingText.textContent = newText;
            } else {
              position = -textWidth;
            }
          }

          scrollingText.style.left = position + "px";
          scrollAnimation = requestAnimationFrame(animate);
        }

        animate();
      }

      // Hiển thị item mới
      function showNewItem(donation, keepVisible = false) {
        if (!config.showNewItem) return;
        const newItemText = document.getElementById("new-item-text");
        newItemText.innerHTML = `
          <span style="display: block; text-align: center;">
            ${donation.name}<br>
            ${donation.amount.toLocaleString("vi-VN")} VNĐ
          </span>`;
        newItemText.style.display = "block";
        newItemText.style.opacity = "1";

        // Clear các timeout và interval cũ
        if (newItemTimeout) clearTimeout(newItemTimeout);
        if (newItemBlinkInterval) clearInterval(newItemBlinkInterval);
        if (newItemHideTimeout) clearTimeout(newItemHideTimeout);

        // Dừng auto loop khi có item mới
        stopAutoLoop();
        lastNewItemTime = Date.now();

        function doBlink() {
          let count = 0;
          const blinkTimes = 3;
          const blinkSpeed = 250;

          const blinkTimer = setInterval(() => {
            if (count >= blinkTimes * 2) {
              clearInterval(blinkTimer);
              newItemText.style.opacity = "1";
              return;
            }

            newItemText.style.opacity = count % 2 === 0 ? "0" : "1";
            count++;
          }, blinkSpeed);
        }

        // Nhấp nháy lần đầu sau N giây
        newItemTimeout = setTimeout(() => {
          doBlink();

          // Tiếp tục nhấp nháy mỗi N giây
          newItemBlinkInterval = setInterval(() => {
            doBlink();
          }, config.newItemBlinkInterval * 1000);
        }, config.newItemBlinkInterval * 1000);

        // Nếu không keepVisible, ẩn sau thời gian quy định
        if (!keepVisible) {
          newItemHideTimeout = setTimeout(() => {
            newItemText.style.display = "none";
            // Bắt đầu auto loop sau khi ẩn
            startAutoLoopCountdown();
          }, (config.newItemDisplayTime || 10) * 1000);
        }
      }

      // Bắt đầu đếm ngược để auto loop
      function startAutoLoopCountdown() {
        console.log(
          "AutoLoop bắt đầu đếm ngược: ",
          new Date().toLocaleTimeString()
        );
        if (autoLoopTimeout) clearTimeout(autoLoopTimeout);

        const autoLoopTime = (config.autoLoopTime || 30) * 1000;

        autoLoopTimeout = setTimeout(() => {
          startAutoLoop();
        }, autoLoopTime);
      }

      // Bắt đầu auto loop hiển thị từng item (giới hạn số lượng)
      function startAutoLoop() {
        if (config.donations.length === 0 || !config.showNewItem) return;

        // Dừng auto loop cũ nếu có
        stopAutoLoop();

        // Lấy X items gần nhất cho auto loop
        const limit = config.autoLoopItemLimit || 50;
        const itemsForLoop = config.donations.slice(-limit);

        if (itemsForLoop.length === 0) return;

        currentAutoLoopIndex = 0;

        function showNextItem() {
          // Kiểm tra lại config mới nhất
          const saved = localStorage.getItem("scrollingTextConfig");
          if (saved) {
            const latestConfig = JSON.parse(saved);
            if (latestConfig.donations.length === 0) {
              stopAutoLoop();
              return;
            }

            // Cập nhật config và lấy items mới
            config = latestConfig;
            const limit = config.autoLoopItemLimit || 50;
            const updatedItems = config.donations.slice(-limit);

            if (updatedItems.length === 0) {
              stopAutoLoop();
              return;
            }

            // Reset index nếu vượt quá
            if (currentAutoLoopIndex >= updatedItems.length) {
              currentAutoLoopIndex = 0;
            }

            const donation = updatedItems[currentAutoLoopIndex];
            const donationCopy = { ...donation };
            showNewItemForAutoLoop(donationCopy);

            currentAutoLoopIndex =
              (currentAutoLoopIndex + 1) % updatedItems.length;
          } else {
            if (currentAutoLoopIndex >= itemsForLoop.length) {
              currentAutoLoopIndex = 0;
            }

            const donation = itemsForLoop[currentAutoLoopIndex];
            const donationCopy = { ...donation };
            showNewItemForAutoLoop(donationCopy);

            currentAutoLoopIndex =
              (currentAutoLoopIndex + 1) % itemsForLoop.length;
          }
        }

        // Hiển thị item đầu tiên ngay
        showNextItem();

        // Lặp lại sau mỗi (displayTime + 2) giây để có thời gian cho nhấp nháy
        const intervalTime = (config.newItemDisplayTime || 10) * 1000 + 2000;
        autoLoopInterval = setInterval(showNextItem, intervalTime);
      }

      // Hiển thị item cho auto loop (không dừng auto loop)
      function showNewItemForAutoLoop(donation) {
        if (!config.showNewItem) return;

        const newItemText = document.getElementById("new-item-text");
        newItemText.innerHTML = `
          <span style="display: block; text-align: center;">
            ${donation.name}<br>
            ${donation.amount.toLocaleString("vi-VN")} VNĐ
          </span>`;
        newItemText.style.display = "block";
        newItemText.style.opacity = "1";

        // Clear các timeout và interval cũ
        if (newItemTimeout) clearTimeout(newItemTimeout);
        if (newItemBlinkInterval) clearInterval(newItemBlinkInterval);
        if (newItemHideTimeout) clearTimeout(newItemHideTimeout);

        function doBlink() {
          let count = 0;
          const blinkTimes = 3;
          const blinkSpeed = 250;

          const blinkTimer = setInterval(() => {
            if (count >= blinkTimes * 2) {
              clearInterval(blinkTimer);
              newItemText.style.opacity = "1";
              return;
            }

            newItemText.style.opacity = count % 2 === 0 ? "0" : "1";
            count++;
          }, blinkSpeed);
        }

        // Nhấp nháy lần đầu sau N giây
        newItemTimeout = setTimeout(() => {
          doBlink();

          // Tiếp tục nhấp nháy mỗi N giây
          newItemBlinkInterval = setInterval(() => {
            doBlink();
          }, config.newItemBlinkInterval * 1000);
        }, config.newItemBlinkInterval * 1000);

        // Ẩn sau thời gian quy định
        newItemHideTimeout = setTimeout(() => {
          newItemText.style.display = "none";
        }, (config.newItemDisplayTime || 10) * 1000);
      }

      // Dừng auto loop
      function stopAutoLoop() {
        if (autoLoopTimeout) {
          clearTimeout(autoLoopTimeout);
          autoLoopTimeout = null;
        }
        if (autoLoopInterval) {
          clearInterval(autoLoopInterval);
          autoLoopInterval = null;
        }
      }

      // Kiểm tra thay đổi dữ liệu
      function checkForUpdates() {
        const saved = localStorage.getItem("scrollingTextConfig");
        if (saved) {
          const newConfig = JSON.parse(saved);

          if (newConfig.donations.length > lastDonationCount) {
            const newDonation =
              newConfig.donations[newConfig.donations.length - 1];
            const keepVisible = newDonation.keepVisible || false;

            showNewItem(newDonation, keepVisible);

            const scrollingText = document.getElementById("scrolling-text");
            const currentPos = parseFloat(scrollingText.style.left) || 0;
            const textWidth = scrollingText.offsetWidth;

            if (currentPos <= -textWidth) {
              config = newConfig;
              lastDonationCount = config.donations.length;
              applyConfig();
              startScrolling();
            } else {
              config = newConfig;
              lastDonationCount = config.donations.length;
              applyConfig();
            }

            // Nếu keepVisible, không bắt đầu countdown
            if (!keepVisible) {
              startAutoLoopCountdown();
            }
          } else if (newConfig.donations.length < lastDonationCount) {
            // Có item bị xóa
            config = newConfig;
            lastDonationCount = config.donations.length;
            applyConfig();

            // Nếu không còn item nào keepVisible, ẩn new-item-text
            const hasKeepVisible = config.donations.some((d) => d.keepVisible);
            if (!hasKeepVisible) {
              const newItemText = document.getElementById("new-item-text");
              newItemText.style.display = "none";
            }
          } else {
            config = newConfig;
            lastDonationCount = config.donations.length;
            applyConfig();
          }
        }
      }

      // Mở trang cấu hình
      function openSettings() {
        window.open("setting.html", "_blank");
      }

      // Khởi động
      window.addEventListener("load", () => {
        loadData();
        startScrolling();

        // Kiểm tra xem có item nào keepVisible không
        const hasKeepVisible = config.donations.some((d) => d.keepVisible);
        if (hasKeepVisible) {
          const lastDonation = config.donations[config.donations.length - 1];
          if (lastDonation.keepVisible) {
            showNewItem(lastDonation, true);
          }
        } else if (config.donations.length > 0) {
          // Bắt đầu auto loop ngay lập tức khi load trang
          startAutoLoop();
        }

        // Kiểm tra cập nhật mỗi giây
        setInterval(checkForUpdates, 1000);
      });

      // Cập nhật khi thay đổi kích thước màn hình
      window.addEventListener("resize", () => {
        startScrolling();
      });
    </script>
  </body>
</html>
